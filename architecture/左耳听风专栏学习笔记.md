
[TOC]


## 25 分布式系统关键技术：服务调度
关键点：
服务关键程度
服务依赖关系
服务发现
整个架构的版本管理
服务应用生命周期全管理

## 流量与数据调度
流量调度关键技术：
- 高性能
- 扛流量
- 业务逻辑
- 服务化

以上4个特性，其实主要是在说API网关应该具备的特点。

#### 分布式事务一致性问题
数据副本是分布式解决数据丢失异常的唯一解决手段。
解决方案：
- Master/Slave
- Master/Master
- 两阶段与三阶段提交方案
- Paxos方案

应用层解决事务问题：两阶段提交
数据层解决事务问题：Paxos算法


## 27 洞悉PaaS平台的本质
首先还是抛出问题吧：
**为了构建一个分布式系统，我们面临的主要问题有:**
- 故障是常态，需要运维流程自动化
- 良好的服务设计，避免单点故障
- 容量的可伸缩性
- 老的服务可能是异构的，需要让它们使用标准化的协议
- 分布式存储使得事务处理变得复杂，事务无法自动恢复时，手工恢复将会很复杂
- 测试和查错的复杂度增大
- 系统吞度量会变大，但同时响应时间会变长

为了解决这些问题，了解了如下解决方案：
- 完善的监控系统
- 设计服务时要分析其依赖链
- 重构老的软件，使其服务化
- 为老的服务编写接口逻辑，以便使用标准协议，或必要时重构老的服务
- 自动构建服务的依赖地图
- 使用API网关
- 事务处理建议在存储层实现；根据业务需求，或是降级使用更简单、吞吐量更大的最终一致性方案，或是通过二阶段提交、paxos、raft、NWR等方案之一，使用吞吐量小的强一致性方案
- 异步调用；关键服务采用专属硬件资源，优化软件逻辑
  

## 41 弹力设计篇之“认识故障和弹力设计”
分布式系统中，可能出现多种问题，不出现故障基本不可能，需要考虑出现故障时如何尽快修复故障。
可能出现的故障主要有：
- 网络问题
- 性能问题
- 安全问题
- 运维问题
- 管理问题
- 硬件问题
  
故障不可避免，就需要**把处理故障的代码当成正常的功能做在架构里写在代码里**

左耳朵耗子叔这里说的弹力设计 Resiliency 主要是指：
- 好的情况下，系统出现故障后，能够自动修复，不需要人为介入
- 如果修复不了，系统能够自我保护，不让事态变得更糟

## 42 弹力设计篇之“隔离设计”
隔离设计所要解决的问题：发生故障时使故障隔离，不要导致系统整体不可用，减小影响范围
分离的方式：
- 以服务的种类来做分离
  - 异步处理，两阶段提交
- 以用户的请求来做分离
  - 多租户架构

## 43 弹力设计篇之“异步通讯设计”
系统间通讯，主要有2种：同步，异步

同步调用的问题：
- 整个同步调用链的性能会由最慢的那个服务所决定。
- 同步调用会导致调用方一直在等待被调用方完成，如果一层接一层地同步调用下去，所有的参与方会有相同的等待时间。高并发场景下，非常消耗资源。
- 同步调用只能是一对一的，很难做到一对多。
- 被调用方失败，调用方也会跟着失败，故障蔓延

异步通讯的方式：
- 1. 请求响应式
  - 又分为：发送方定期查询接收方是否完成，以及发送方注册回调、接收方完成后掉回调这两种。
- 2. 通过订阅的方式
  - 发送方发送事件，事件驱动
  - 缺点：接收方依赖于发送方，还是有耦合
- 3. 通过 Broker 的方式
  - 同样依赖于事件，但发送方、接收方都使用broker通信
  - 2和3都是**事件驱动设计**

### 事件驱动
- 优点
  - 消除了服务间依赖，每个服务都是高度可重用并可被替换的。
  - 开发、测试、运维，以及故障处理都是高度隔离的
  - 服务间是不会相互 block 的
  - 服务间增加一些 Adapter（如日志、认证、版本、限流、降级、熔断等）相当容易。
  - 服务间的吞吐也被解开了，各个服务可以按照自己的处理速度处理。
- 缺点
  - 业务流程不再那么明显和好管理。整个架构变得比较复杂
  - 事件可能会乱序。
  - 事务处理变得复杂。需要使用两阶段提交来做强一致性，或是退缩到最终一致性。

### 异步通讯
- 为何要异步通讯？
  - 解耦服务间的依赖
  - 让各个服务的隔离性更好，避免出故障时故障蔓延
  - 可以获得更大的吞吐量，而且各个服务间的性能不受干扰相对独立
  - 利用 Broker 或队列的方式还可以达到把抖动的吞吐量变成均匀的吞吐量，这就是所谓的“削峰”，这对后端系统是个不错的保护。
  - 部署、扩容和运维上都可以做到独立不受其他服务的干扰。
- 注意事项：
- 用于异步通讯的中间件 Broker需要设计成高可用不丢消息的；消息无法保证顺序，架构设计不要依赖于消息的顺序
- 业务处理流程不那么直观，在 Broker 上需要有相关的服务消息跟踪机制
- 业务状态最好由一个总控方来管理，用于维护一个业务流程的状态变迁逻辑，便于发生故障时查找问题、以及故障恢复
- 若消息可能重传，需要处理方有幂等的处理

## 44 弹力设计篇之“幂等性设计”
保证幂等性的几种方式：
- 需要有**全局ID**
  - SnowFlake算法
  - 数据库实现
  - Redis/MongoDB实现
  以上算法大同小异
- 处理流程
  - 实际执行操作时查询一下？
    - 有问题，多数情况不会发生重复，导致很多操作都是白费力，消耗资源
  - 使用id，保存时如果有重复直接抛错

HTTP的幂等性
- PRG模式
