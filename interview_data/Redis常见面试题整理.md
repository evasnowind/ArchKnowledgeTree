# Redis常见面试题整理

## 1. Redis内存耗尽后会怎样？

### 过期策略

- Redis可以给键设置过期策略，常见策略：
  - 定时删除
    - 每个键设置一个定时器，对内存友好，对CPU不友好
  - 惰性删除
    - 不管是否过期都不删除，直到每次去获取这个key的时候再判断是否过期，若过期则删除。
    - 对内存不友好，对CPU友好
  - 定期删除
    - 每隔一段时间定期扫描一次，有过期则删除，是上面两者的这种。
- Redis采用定期删除+惰性删除，但Redis定期删除设置了过期时间的key

### 淘汰机制

8种。

假如 `Redis` 当中所有的键都没有过期，而且此时内存满了，那么客户端继续执行 `set` 等命令时 `Redis` 会怎么处理呢？`Redis` 当中提供了不同的淘汰策略来处理这种场景。

首先 `Redis` 提供了一个参数 `maxmemory` 来配置 `Redis` 最大使用内存。

如果没有设置该参数，那么在 `32` 位的操作系统中 `Redis` 最多使用 `3GB` 内存，而在 `64` 位的操作系统中则不作限制。

`Redis` 中提供了 `8` 种淘汰策略，可以通过参数 `maxmemory-policy` 进行配置：

| 淘汰策略        | 说明                                                         |
| :-------------- | :----------------------------------------------------------- |
| volatile-lru    | 根据 LRU 算法删除设置了过期时间的键，直到腾出可用空间。如果没有可删除的键对象，且内存还是不够用时，则报错 |
| allkeys-lru     | 根据 LRU 算法删除所有的键，直到腾出可用空间。如果没有可删除的键对象，且内存还是不够用时，则报错 |
| volatile-lfu    | 根据 LFU 算法删除设置了过期时间的键，直到腾出可用空间。如果没有可删除的键对象，且内存还是不够用时，则报错 |
| allkeys-lfu     | 根据 LFU 算法删除所有的键，直到腾出可用空间。如果没有可删除的键对象，且内存还是不够用时，则报错 |
| volatile-random | 随机删除设置了过期时间的键，直到腾出可用空间。如果没有可删除的键对象，且内存还是不够用时，则报错 |
| allkeys-random  | 随机删除所有键，直到腾出可用空间。如果没有可删除的键对象，且内存还是不够用时，则报错 |
| volatile-ttl    | 根据键值对象的 ttl 属性， 删除最近将要过期数据。如果没有，则直接报错 |
| noeviction      | **默认策略，不作任何处理，直接报错**                         |

> 备注：LRU和LFU 可以参考这篇 https://blog.csdn.net/a3192048/article/details/82291222
>
> - LRU 最近最少使用算法，如果数据最近被访问过，那么将来被访问的几率也更高。
> - LFU 最不经常使用，如果一个数据在最近一段时间内使用次数很少，那么在将来一段时间内被使用的可能性也很小。



## 2. Redis的hotkey 问题是什么？怎么解决？

- 什么是hotkey？
  - 比如秒杀活动，或者说微博上某个明星突然有热点新闻，导致Redis中某条记录段时间内被大量访问、比如本来平时峰值10w，但实际请求量到了50w，导致集群中访问量很不均衡、过于集中，某个Redis实例达到性能瓶颈或是物理网卡瓶颈。可能会带来的问题：1、这个Redis实例由于访问量过大、可能挂掉，进而引发类似服务雪崩的情况，因为这个hotkey在本Redis实例挂掉后，又会写入别的Redis实例，但请求量依然会很大，导致整个Redis逐步挂掉。
  - 

需要分两个角度去聊：

- 如何发现hotkey？
  - 业务上预估
    - 比如秒杀商品往往是热点
    - 不精确
  - 客户端收集（常见）
    - 在访问redis前加一行代码进行数据统计，或是代理层
  - redis监控功能
    - monitor命令 
    - redis-cli 4.0.3提供了hotkey检查功能，但在redis比较忙的时候没法
  - 网络抓包
  - 基于大数据流式计算
- 如何解决hotkey问题？

